# 手机端与浏览器响应性能优化日志 (2024-10-28)

## 1. 存储层优化：数据冷热分离 (P0/P1)

**问题**：手机端保存小说时卡顿几秒，主因是 `localStorage` 同步读写及大型 JSON (百万字级别) 频繁序列化阻塞主线程。
**改进**：

- **迁移 IndexedDB**：在 `src/utils/storage.ts` 中使用 `idb-keyval` 实现完全异步的持久化。
- **剥离历史版本**：保存主数据时自动剥离 `chapters.versions`。
  - **热数据** (当前正文、大纲、设定) 保持在几 KB 级别，极速序列化。
  - **冷数据** (章节历史版本) 独立按需存储，仅在切换版本时异步加载。
- **结果**：手机端点击保存、自动保存已实现“零感知”。

## 2. 渲染性能优化：链路隔离与节流 (P2)

**问题**：AI 流式输出文字时，极高频的 UI 更新导致整棵 DOM 树（App.tsx 9000+行）重绘，造成浏览器无响应。
**改进**：

- **流式输出节流 (Throttling)**：
  - 润色、续写、自动化创作的 UI 更新频率限制为 **150ms-200ms** 一次。
  - 显著降低 CPU 负载，文字滚动时页面依然可操作。
- **组件级缓存 (React.memo)**：
  - 封装并缓存了 `CharacterManager`、`WorldviewManager`、`ChapterEditor` 等重型模块。
- **回调稳定化 (React.useCallback)**：
  - 稳定了所有下发给子组件的回调函数引用，防止无关状态更新导致子树重排。

## 3. 任务调度优化：智能保存挂起

**问题**：后台自动保存任务与前台流式输出抢占 CPU 资源。
**改进**：

- **状态感知**：自动保存逻辑现在会感知 AI 运行状态。
- **动态延迟**：正在生成、润色或全自动写作时，自动暂停后台写入，待系统空闲后再执行一次性保存。

## 4. 交互体验优化

- **消除点击延迟**：在全局 CSS 中应用 `touch-action: manipulation`，移除了移动端浏览器默认的 300ms 点击延迟。
- **修复运行时错误**：
  - 修复了 `lazy` 加载与 `React.memo` 配合时的解析报错。
  - 修复了 `App.tsx` 中状态初始化顺序导致的 `ReferenceError`。

---
**优化结论**：经过测试，应用在低端 Android 手机上的操作流畅度提升显著，PC 端在高并发自动化创作下的稳定性也得到了根本性改善。
