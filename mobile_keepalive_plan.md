# 手机端网页后台保活与稳定性增强计划书

## 1. 背景与问题分析

**当前问题**：
当 AI 小说创作页面在手机端运行自动化任务（如自动生成大纲、批量生成章节）时，一旦用户将浏览器切换至后台（切换应用或锁屏），移动操作系统（iOS/Android）为了省电，会迅速冻结网页的 JavaScript 执行引擎，导致 AI 生成请求中断、WebSocket/HTTP 连接断开。

**技术挑战**：
纯前端网页应用（SPA）没有后端服务器托管任务，所有逻辑完全依赖用户设备的浏览器线程。移动端浏览器对后台网页的资源限制极严，通常没有官方的 API 支持网页长期后台运行。

## 2. 解决方案：组合式“保活”策略

为了在纯前端环境下最大程度地突破系统限制，我们将采用 **“防锁屏 + 音频欺骗 + 状态持久化”** 的组合策略。

### 策略 A：屏幕唤醒锁 (Screen Wake Lock API)
**目标**：防止用户在盯着屏幕等待生成时，因长时间无触摸操作导致手机自动锁屏从而切断网络。
**原理**：调用浏览器原生的 `navigator.wakeLock` API，申请屏幕常亮。
**效果**：只要网页在前台，屏幕就不会变黑，任务就能一直跑。

### 策略 B：静音音频循环 (Invisible Audio Hack) —— **核心后台保活手段**
**目标**：欺骗操作系统，让系统认为当前网页是一个“正在播放音乐”的媒体应用，从而在后台给予更高的 CPU 优先级和存活时间。
**原理**：
1. 在网页中加载一个极短的、听不见的静音音频文件（0.1秒的空白 mp3）。
2. 当任务开始时，循环播放这个静音音频。
3. 浏览器会向系统申请“后台媒体播放”权限，从而保持 JavaScript 线程在后台继续活跃。
**效果**：显著延长后台存活时间（从几秒延长至几分钟甚至更久，视系统内存情况而定）。

### 策略 C：断点恢复机制 (容错兜底)
**目标**：万一系统强行杀掉了浏览器进程，用户重新打开网页时，能恢复到之前的进度，而不是从头开始。
**原理**：
1. 利用 `localStorage` 或 `IndexedDB` 实时保存当前的生成队列和进度。
2. 页面加载时检查是否有“未完成的自动写入任务”。
**效果**：虽然不能阻止被杀，但能降低被杀后的损失。

## 3. 实施步骤

我们将分三个阶段修改 `src/App.tsx` 和相关组件：

### 第一阶段：基础设施搭建
1.  **添加 Wake Lock 支持**：
    - 在 `App` 组件挂载时请求唤醒锁。
    - 处理页面可见性变化（Visibility Change），在前台时重新申请锁。
2.  **创建 KeepAlive 组件**：
    - 创建一个不可见的 `<audio>` 元素。
    - 准备 Base64 编码的静音音频数据。

### 第二阶段：集成到自动化流程
1.  **修改 `startAutoWriting`**：
    - 任务开始时 -> 激活 Wake Lock，开始播放静音音频。
2.  **修改 `autoWriteLoop`**：
    - 任务结束（成功或失败）-> 释放 Wake Lock，停止播放音频。
    - 在每次 AI 请求前后，更新本地存储中的“当前进度指针”。

### 第三阶段：UI 反馈
1.  **添加“后台运行模式”开关**：
    - 在设置或自动化中心添加一个开关：“启用后台防中断模式”。
    - 当开关开启时，用户需要先与页面交互（点击一下），才能触发音频播放（浏览器策略限制自动播放）。

## 4. 代码变更预览

**文件**：`src/App.tsx` 或新建 `src/utils/keepAlive.ts`

```typescript
// 伪代码示例：静音音频保活
export class AudioKeeper {
  private audio: HTMLAudioElement;

  constructor() {
    // 0.1秒的静音 MP3 Base64
    const silentMP3 = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTVF......'; 
    this.audio = new Audio(silentMP3);
    this.audio.loop = true;
  }

  enable() {
    this.audio.play().catch(() => console.log('需用户交互才能播放'));
  }

  disable() {
    this.audio.pause();
  }
}
```

## 5. 局限性告知

虽然上述方案能解决 90% 的场景，但用户需知晓：
1.  **耗电量增加**：保持屏幕常亮和后台音频播放会增加手机耗电。
2.  **非绝对不死**：如果是内存极小的低端机型，或者系统开启了“超级省电模式”，即使播放音频也可能被强制杀进程。
3.  **音频焦点**：如果用户在后台打开网易云音乐或抖音，可能会抢占音频焦点导致网页保活失效。

## 6. 下一步行动

如果您批准此计划，我将开始：
1.  修改代码，引入 Wake Lock API。
2.  实现静音音频播放逻辑，并在自动化任务开始时触发。
