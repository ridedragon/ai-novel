# 修复日志 - 2024/10/27 (Part 2)

## 1. 自动总结生成逻辑优化

- **Bug 修复**：修复了设置总结间隔后，初始章节（如1-3章）总结丢失的问题。
- **原因**：之前的逻辑仅在章节数正好等于倍数时触发单次生成，如果错过了触发点（如通过批量导入或快速生成跳过），则之前的总结永远不会生成。
- **改进点**：在触发总结检查时，程序现在会采用“补全模式”，扫描当前及之前所有应触发但未生成的区段，确保总结链条的完整性。

## 2. 工作流执行逻辑增强

- **Bug 修复**：解决了重新执行工作流时可能跳过前面章节生成节点的问题。
- **原因**：由于工作流内部状态持久化机制，重新开始时如果未正确清空之前的执行索引，会导致逻辑判断认为节点已完成。
- **新功能实现**：
  - **跳转执行**：在 PC 和移动端工作流编辑器中，用户现在可以从下拉菜单中选择任意节点作为起始点开始执行工作流。
  - **节点跳过**：在节点配置界面增加了“跳过”开关（Skipped），用户可以灵活排除不需要自动执行的任务（例如已手动完成的章节）。已跳过的节点在执行时会瞬间标记为完成。
  - **进度重置**：增加了“重置进度”按钮（Settings2 图标），一键清理所有节点的执行状态，方便从头开始测试。

## 3. 移动端保活与稳定性

- **Bug 修复**：针对手机端工作流在后台运行或息屏时突然显示停止的问题。
- **改进点**：引入了 `KeepAliveManager` 联动。现在，当工作流开始运行时，会自动开启：
  - **静音音频保活**：通过持续播放一段极小音量的无声 WAV 音频，提升浏览器进程在移动系统后台的优先级。
  - **WakeLock (屏幕锁)**：请求屏幕常亮，防止由于手机系统进入休眠导致的 JavaScript 执行挂起。
  - **自动注销**：在工作流正常结束、手动终止或发生错误时，会自动释放保活资源，节省电量。

## 4. 数据一致性与 UI 交互

- **改进点**：
  - **移动端 UI 优化**：针对手机端按钮拥挤且图标含义不明确的问题，为顶部工具栏、配置面板和悬浮操作栏的所有主要按钮增加了文字标注（如“运行”、“保存”、“停止”、“继续”、“重置”、“克隆”等），并优化了触控间距。
  - 在工作流执行过程中，优化了节点标签的实时反馈（显示“创作中: 第X章”）。
  - 修复了移动端配置面板打字时的渲染干扰，采用非受控组件模式提升流畅度。
  - 增强了总结生成与 React 状态同步的逻辑，采用函数式更新防止内容回滚。

## 5. 再次修复：自动总结丢失与重复问题 (2024-10-28)

- **Bug 修复**：解决了工作流执行过程中 1-3 章小总结消失以及出现重复总结的问题。
- **根因分析**：
    1. **触发点遗漏**：工作流在“跳过已存在章节”时未触发总结检查，导致如果手动创建了前几章，自动总结链条会从中间断裂。
    2. **并发竞争导致覆盖 (Stale State)**：在 `AutoWriteEngine` 中使用 `Promise.all` 并行上报章节完成，导致多个总结生成任务同时修改 `novels` 状态，产生竞态条件，旧状态覆盖了新生成的总结。
    3. **锁机制缺失**：流式生成和批次结束阶段可能同时触发同一范围的总结请求，导致生成了内容略有差异的重复条目。
- **修复方案**：
    1. **强制跳过补偿 ([`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts))**：在跳过已存在章节时，显式调用一次 `onChapterComplete`，确保总结检查覆盖到所有章节。
    2. **串行化上报逻辑**：将批次完成后的并行处理改为 `for` 循环串行处理，确保状态更新按顺序进行，彻底消灭竞态引起的“总结回滚”。
    3. **引入全局生成锁 ([`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts))**：在 `SummaryManager` 中增加 `activeGenerations` 内存锁，确保同一范围内同一时间仅有一个 AI 请求在运行，消灭重复总结。

## 6. 第三次修复：解决节点长时间卡在“创作中”的问题 (2024-10-28)

- **Bug 修复**：修复了工作流执行结束后，最后一个正文生成节点依然显示“创作中：完成”或“创作中：创作完成”的问题。
- **根因分析**：
    1. **状态更新冲突**：在 `WorkflowEditor` 中，`engine.run` 返回后立即重置了节点标签为“默认名”，但这与 `onStatusUpdate` 的异步回调可能产生竞态，导致标签被覆盖回“创作中”。
    2. **判定逻辑陈旧**：UI 层的 `isTerminal` 判定逻辑仅包含旧版的“完成”字符串，而引擎在某些情况下返回了不同的状态语。
- **修复方案**：
    1. **状态原子化更新 ([`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx))**：在 `await engine.run` 结束后，不再执行两次零散的 `updateNodeData` 和 `setNodes`，而是合并为单次更新，确保标签和状态（Completed）同步锁定。
    2. **增强终端状态判定**：UI 层的标签处理器现在能识别“完成”、“失败”、“跳过”、“错误”等多种终态关键词，确保不再误加“创作中：”前缀。
    3. **引擎终态标准化 ([`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts))**：标准化引擎结束时的 `onStatusUpdate` 调用，确保其能被 UI 层精准捕获。
