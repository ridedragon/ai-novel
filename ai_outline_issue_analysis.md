# AI 模块现有条目识别问题深度调查报告

## 1. 大纲模块 (Outline) - 确认存在“数据漏发”缺陷

**问题定位：** 在非聊天模式下，AI 确实无法读取到已存在的大纲内容。

**技术原因：**
在 `handleGenerateOutline` 函数中，存在一个错误的逻辑判断：

```typescript
// src/App.tsx:2924
if (mode === 'append' && targetSet && targetSet.items && targetSet.items.length > 0) {
    // 只有在 append 模式下才会构建 outlineContext
}
```

* **后果 1：** 当用户执行“重生成全部” (`mode === 'replace'`) 时，该判断不通过，导致已有大纲内容**未被发送**给 AI。
* **后果 2：** 虽然您提到聊天模式正常，但从代码看，`mode === 'chat'` 时该内容同样未发送。聊天模式之所以显得“正常”，可能是因为对话历史 (`chatContext`) 中包含了之前讨论过的内容，或者您在聊天时手动选择了参考项。
* **对比：** 在“生成大纲”按钮触发的 `append` 模式下，内容理论上应发送，但由于使用了非标准的字符串拼接格式，可能导致 AI 识别效率不如其他模块。

## 2. 其他模块横向对比

| 模块           | 现有内容发送逻辑                     | 状态     |
| :------------- | :----------------------------------- | :------- |
| **故事大纲**   | **受 mode 限制**，仅 append 模式发送 | **异常** |
| **灵感激发**   | **无限制**，始终发送全量 JSON        | 正常     |
| **角色设计**   | **无限制**，始终发送全量 JSON        | 正常     |
| **世界观构建** | **无限制**，始终发送全量 JSON        | 正常     |

## 3. 为什么 AI 会重新生成全部条目？

由于大纲模块在生成时，AI 无法从 `{{context}}` 中读取到已有的 `targetSet.items`（除非是 append 模式且逻辑触发成功），它会根据系统指令“生成一份详细的大纲”从第一章开始构思。

## 4. 修复方案 (已实施)

1. **修复数据发送漏洞**：修改了 `src/App.tsx` 中的 `handleGenerateOutline` 函数，移除了对 `mode === 'append'` 的限制。现在无论是“追加”、“重生成全部”还是“聊天模式”，AI 都能完整接收到当前的大纲内容。
2. **优化数据传输格式**：将大纲内容的组装逻辑从“手拼字符串”改为标准的 `JSON.stringify` 格式。这使得 AI 能够以结构化的方式更准确地解析现有章节。
3. **重构预设提示词 (Prompt)**：更新了 `defaultOutlinePresets`。
   - 明确要求 AI “生成或**补充**大纲列表”。
   - 增加了显式的 `【现有大纲列表】` 标签。
   - 指令引导从“生成全书大纲”转变为“基于现有进度继续规划”。
