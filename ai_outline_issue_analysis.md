# AI 模块现有条目识别问题深度调查报告

## 1. 大纲模块 (Outline) - 确认存在“数据漏发”缺陷

**问题定位：** 在非聊天模式下，AI 确实无法读取到已存在的大纲内容。

**技术原因：**
在 `handleGenerateOutline` 函数中，存在一个错误的逻辑判断：

```typescript
// src/App.tsx:2924
if (mode === 'append' && targetSet && targetSet.items && targetSet.items.length > 0) {
    // 只有在 append 模式下才会构建 outlineContext
}
```

* **后果 1：** 当用户执行“重生成全部” (`mode === 'replace'`) 时，该判断不通过，导致已有大纲内容**未被发送**给 AI。
* **后果 2：** 虽然您提到聊天模式正常，但从代码看，`mode === 'chat'` 时该内容同样未发送。聊天模式之所以显得“正常”，可能是因为对话历史 (`chatContext`) 中包含了之前讨论过的内容，或者您在聊天时手动选择了参考项。
* **对比：** 在“生成大纲”按钮触发的 `append` 模式下，内容理论上应发送，但由于使用了非标准的字符串拼接格式，可能导致 AI 识别效率不如其他模块。

## 2. 其他模块横向对比

| 模块           | 现有内容发送逻辑                     | 状态     |
| :------------- | :----------------------------------- | :------- |
| **故事大纲**   | **受 mode 限制**，仅 append 模式发送 | **异常** |
| **灵感激发**   | **无限制**，始终发送全量 JSON        | 正常     |
| **角色设计**   | **无限制**，始终发送全量 JSON        | 正常     |
| **世界观构建** | **无限制**，始终发送全量 JSON        | 正常     |

## 3. 为什么 AI 会重新生成全部条目？

由于大纲模块在生成时，AI 无法从 `{{context}}` 中读取到已有的 `targetSet.items`（除非是 append 模式且逻辑触发成功），它会根据系统指令“生成一份详细的大纲”从第一章开始构思。

## 4. 修复方案建议

1. **取消模式限制**：修改 `src/App.tsx`，将大纲内容的组装逻辑移出 `if (mode === 'append')` 判断，确保 `outlineContext` 在任何生成模式下都包含当前已有的条目。
2. **标准化格式**：效仿角色集模块，使用 `JSON.stringify(targetSet.items)` 发送数据，提高 AI 的理解深度。
3. **优化提示词位置**：确保 `{{context}}` 在大纲预设提示词中处于核心位置，并配以明确的“这是当前已有大纲”的标签。
