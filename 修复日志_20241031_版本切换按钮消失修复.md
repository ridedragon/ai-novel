# 修复日志 - 2024/10/31

## 问题背景

在页面重新加载后，章节编辑器的版本切换按钮（原文/优化版）消失。

## 原因分析

1. **冷热分离存储**：为了性能优化，`src/utils/storage.ts` 在 `saveNovels` 时会剥离 `versions` 数组，单独存储在 IndexedDB 中。
2. **被动加载失效**：`App.tsx` 中的 `loadVersionsIfNeeded` 仅在用户触发版本切换操作时运行。但由于初始加载的主数据不含 `versions`，`ChapterEditor` 组件根据 `versions.length > 1` 的条件隐藏了切换 UI，导致用户无法操作，陷入死循环。

## 修复措施

1. **主动加载机制**：在 [`src/App.tsx`](src/App.tsx) 的章节切换 `useEffect` 中，增加自动加载版本历史的逻辑。
2. **按需异步拉取**：当检测到 `activeChapter` 存在但 `versions` 为空时，主动调用 `storage.getChapterVersions(chapter.id)` 并更新状态。
3. **并发安全保护**：在更新状态前检查内存中的 `versions` 状态，确保不会覆盖正在进行的实时润色内容。

## 验证建议

- 打开一个包含多个版本的章节。
- 刷新页面。
- 检查顶部版本切换按钮是否在短暂加载后恢复显示。
- 尝试切换版本，确保内容显示正常。

---
**修复人员**：Kilo Code
