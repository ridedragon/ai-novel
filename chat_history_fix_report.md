# Chat History 显示不全问题分析与修复报告

## 问题描述

用户反馈在开启“长上下文模式”及“连贯创作”（Batching）时，Chat History（发送给 AI 的上下文）会出现章节缺失的情况。例如创作了 8 章内容，但在对话历史中只能看到部分内容。

## 原因分析

经过对代码的深入审计，发现了以下两个核心逻辑漏洞：

### 1. 长上下文构建逻辑漏洞 (App.tsx - getChapterContext)

在 `getChapterContext` 函数中，系统通过“大总结”（Big Summary）和“小总结”（Small Summary）来压缩历史。

- **问题**：系统目前只选取 **最后一个** 符合条件的“大总结”放入上下文。
- **后果**：如果小说较长，存在多个“大总结”（如 1-6 章，7-12 章），当进行到第 13 章时，系统只选取了 7-12 章的总结，导致 1-6 章的内容彻底从 AI 的记忆中消失。
- **关联**：这解释了为什么用户看到的章节内容“减半”或“部分缺失”。

### 2. 异步状态同步问题 (App.tsx - autoWriteLoop & SummaryManager)

在“连贯创作”模式下，系统会批量生成章节内容（如一次生成 2 章）。

- **问题**：`autoWriteLoop` 在生成完正文后立即调用 `setNovels` 更新状态，并紧接着循环调用 `checkAndGenerateSummary` 生成总结。
- **后果**：由于 React 的 `setNovels` 是异步的，且 `novelsRef.current` 的更新依赖于渲染后的 `useEffect`，导致在同一个异步任务中，`checkAndGenerateSummary` 拿到的是 **旧的（内容为空）** 章节数据。
- **关联**：生成的总结内容可能是空的，或者缺失了刚刚生成的章节。当 AI 在下一轮创作读取这些错误的总结时，就会感觉之前的章节“丢失”了。

## 修复方案

### 1. 修复总结链条

修改 `getChapterContext`，改为收集并按顺序排列 **所有** 之前的“大总结”，确保历史记忆的完整性。同时修正小总结和正文的起始过滤点（`bigEnd`），使其紧随最后一个大总结之后。

### 2. 强化状态同步

- 在 `autoWriteLoop` 中，更新状态时手动同步 `novelsRef.current`，确保后续的总结生成逻辑能立即读取到刚刚生成的正文。
- 在 `setChapters` 等核心状态更新函数中也加入同步 Ref 的逻辑，防止并发操作下的状态竞争。

### 3. 优化总结生成器

在 `SummaryManager.ts` 中增强健壮性，确保在处理章节快照时能正确识别并填充当前正在处理的内容。

## 预期效果

修复后，无论小说写到多少章，长上下文模式都能通过完整的“大总结链 + 近期小总结 + 极近期正文”构筑起连续的记忆，彻底解决章节丢失问题。
