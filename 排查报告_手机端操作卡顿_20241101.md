# 📱 手机端操作卡顿详细排查报告

## 1. 问题背景

用户反馈在手机端进行以下操作时存在严重卡顿：

1. 点击三条杠按钮展开目录侧边栏。
2. 查看节点（章节）内容时。
3. 关闭节点时。

---

## 2. 核心瓶颈分析

### 2.1 根组件 `App.tsx` 的“渲染过载”

* **代码位置**：[`src/App.tsx`](src/App.tsx:941)
* **原因**：`App` 组件规模超过 **9700 行**，且 `isMobileSidebarOpen` 等交互状态直接定义在 `App` 根部。
* **技术细节**：在 React 中，根状态的变化会触发整棵组件树的 Render 过程。虽然子组件有 `memo`，但手机端 CPU 性能有限，在执行庞大的渲染函数逻辑、闭包创建以及虚拟 DOM Diff 时，耗时远超 16.6ms（60FPS 临界值），导致肉眼可见的卡顿。

### 2.2 同步计算阻塞主线程

* **代码位置**：[`src/App.tsx:483`](src/App.tsx:483) (`ensureChapterVersions`) 和 [`src/App.tsx:1766`](src/App.tsx:1766) (`applyRegexToText`)
* **原因**：当点击查看节点时，程序会立即同步执行：
    1. **正则匹配清洗**：对万字长文进行多次正则替换。
    2. **版本历史重建**：计算并生成新的版本数组。
* **后果**：这些逻辑在主线程运行，会产生“计算长尾”，锁死 UI 响应，直到计算完成界面才会跳转。

### 2.3 侧边栏 DOM 节点爆炸

* **代码位置**：[`src/App.tsx:6806`](src/App.tsx:6806)
* **原因**：目录侧边栏目前采用**全量渲染**。如果小说有数百章，手机浏览器需要同时维护数百个包含复杂逻辑和图标的 [`ChapterSidebarItem`](src/App.tsx:856) 节点。
* **后果**：侧边栏滑出时的位移（Transform）动画会触发浏览器的大规模重排（Reflow），在低功耗设备上性能表现极差。

### 2.4 同步存储瓶颈

* **代码位置**：[`src/App.tsx:1417`](src/App.tsx:1417) (`saveNovels` 逻辑)
* **原因**：项目使用同步的 `localStorage` 存储数据。
* **现象分析**：在“关闭节点”或“切换界面”时，通常会触发数据持久化。当小说数据达到数 MB 时，`JSON.stringify` 过程会产生数百毫秒的阻塞，导致交互瞬间停顿。

---

## 3. 优化设计方案

针对以上排查结果，建议实施以下优化：

1. **[状态下沉]**：将 `isMobileSidebarOpen` 等 UI 局部状态从 `App.tsx` 移至专门的布局 Context，实现“开关侧边栏不重绘全应用”。
2. **[虚拟列表化]**：侧边栏引入 `react-window`，仅渲染屏幕可见的 10-15 个章节节点，彻底解决长目录下的内存和动画压力。
3. **[异步存储重构]**：引入 `IndexedDB` (idb-keyval) 替代 `localStorage`，利用浏览器的异步存储能力，让保存操作不再干扰 UI 渲染。
4. **[文本处理 Worker 化]**：将复杂的正则匹配和版本计算移至 Web Worker，在后台线程处理文本，确保交互丝滑。
5. **[硬件加速]**：优化移动端 CSS 动画，强制开启 `will-change: transform`。

---

**结论**：系统当前的架构在处理“长篇小说内容”和“高频移动端交互”时已达到物理极限，必须通过“去中心化”和“异步化”进行底层重构。
