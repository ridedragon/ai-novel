# 长文模式 (Long Text Mode)使用指南

长文模式是本应用的核心功能之一，旨在解决 AI 在创作长篇小说时“遗忘”前文设定和剧情的问题。通过动态构建上下文（Context），长文模式能够让 AI 在有限的上下文窗口（Token Limit）内，感知到更跨度的剧情发展。

## 核心原理

长文模式采用 **“大总结 + 小总结 + 近期正文”** 的三层上下文结构：

1.  **大总结 (Big Summary)**: 宏观剧情概括，覆盖较长的时间跨度（默认每 6 章生成一次）。
2.  **小总结 (Small Summary)**: 详细剧情摘要，覆盖较短的时间跨度（默认每 3 章生成一次）。
3.  **近期正文 (Recent Chapters)**: 最近发生的具体情节，保留原文的细节描写。

### 上下文构建逻辑

当您在长文模式下点击“生成”时，系统会按以下顺序构建发送给 AI 的 Prompt：

1.  **【剧情大纲】**: 寻找最近的一个“大总结”，让 AI 知道当前处于故事的什么阶段。
2.  **【剧情概要】**: 寻找该“大总结”之后的所有“小总结”，填补大纲与当前进度之间的空白。
3.  **【近期正文】**: 寻找最后一个“小总结”之后的所有正文章节，以及当前正在写的章节内容。

这种结构确保了 AI 既知道“大局”（大纲），也知道“细节”（近期正文），同时通过“概要”（小总结）连接两者，极大地节省了 Token。

---

## AI 请求情况详解 (Example Payloads)

以下列举了本应用在不同场景下发送给 AI 的请求示例。这些示例展示了 `messages` 数组的结构。

### 1. 正文生成 (手动创作 - 长文模式激活)

这是最常见的场景。假设您正在写第 10 章，系统配置为每 6 章一个大总结，每 3 章一个小总结。

**重要说明**: 
*   **大纲发送**: 在手动创作模式下，系统 **不会** 自动发送您在“大纲”模块中设定的规划。AI 仅依赖前文（正文和总结）进行续写。如果您希望 AI 按照特定大纲写，请将其手动粘贴到输入框中。
*   **章节感知**: AI 通过上下文中前一章的标题（如 `### 第9章`）来隐式推断当前进度。系统 **不会** 显式告知 AI “现在是第 10 章”，除非您在 Prompt 中写明。
*   **角色与世界观**: 系统 **不会** 自动发送左侧菜单中“角色集”或“世界观”里的详细设定。AI 只能通过前文剧情（Context）来了解角色和世界。如果您有必须遵守的核心设定，请将其放入 **设置 -> System Prompt** 中，或者手动粘贴到输入框。

**场景状态**:
*   已存在：大总结 (1-6章)、小总结 (7-9章)。
*   输入：用户在第 10 章输入框中输入了剧情指令。

**发送给 AI 的消息**:

```json
[
  {
    "role": "system",
    "content": "你是一个专业的小说家。请根据用户的要求创作小说，文笔要优美，情节要跌宕起伏。"
  },
  {
    "role": "system",
    "content": "（这里可能包含您在“对话补全源”中设置的其他预设提示词，如 NSFW 提示等）"
  },
  {
    "role": "user",
    "content": "【前文剧情回顾】：\n\n【剧情大纲 (🔸大总结 (1-6))】：\n（这里是第1-6章的宏观剧情概括...）\n\n【剧情概要 (🔹小总结 (7-9))】：\n（这里是第7-9章的详细剧情摘要...）\n\n### 第10章\n（这里是第10章已经写好的前半部分内容...）\n\n（用户输入的指令，例如：主角突然拔剑，冲向了敌人！）"
  }
]
```

### 2. 自动生成小总结 (Small Summary)

当您写完第 3 章（或设定的间隔倍数）时，系统会自动触发此请求。

**场景状态**:
*   刚刚完成了第 1-3 章的内容。
*   触发条件：当前章节数 (3) % 小总结间隔 (3) == 0。

**发送给 AI 的消息**:

```json
[
  {
    "role": "system",
    "content": "You are a professional editor helper."
  },
  {
    "role": "user",
    "content": "Chapter: 第一章\n（第一章正文内容...）\n\nChapter: 第二章\n（第二章正文内容...）\n\nChapter: 第三章\n（第三章正文内容...）\n\n请把以上小说章节的内容总结成一个简短的剧情摘要（300字以内）。保留关键的人名、地名和事件。"
  }
]
```

### 3. 自动生成大总结 (Big Summary)

当您写完第 6 章（或设定的间隔倍数）时，系统会自动触发此请求。系统会优先使用已有的“小总结”来生成“大总结”，以节省 Token。

**场景状态**:
*   已存在：小总结 (1-3)、小总结 (4-6)。
*   触发条件：当前章节数 (6) % 大总结间隔 (6) == 0。

**发送给 AI 的消息**:

```json
[
  {
    "role": "system",
    "content": "You are a professional editor helper."
  },
  {
    "role": "user",
    "content": "Small Summary (1-3):\n（第1-3章的摘要内容...）\n\nSmall Summary (4-6):\n（第4-6章的摘要内容...）\n\n请根据以上的分段摘要，写一个宏观的剧情大纲（500字以内），概括这段时间内的主要情节发展。"
  }
]
```

### 4. 自动化写作 (Auto Writing)

在“大纲模式”下点击“开始全自动创作”时触发。此模式会遍历大纲条目，逐章生成。

**重要说明**:
*   **大纲发送**: 系统会 **强制发送** “本章大纲”给 AI。如果您勾选了“发送完整大纲上下文”，系统还会发送全书的大纲列表。
*   **章节感知**: 系统会 **显式告知** AI 当前正在创作的章节标题（例如 `当前章节：第二章`），因此 AI 清楚知道自己的进度。
*   **角色与世界观**: 与手动创作一样，自动写作模式 **不会** 自动引用“角色集”或“世界观”模块中的设定。

**场景状态**:
*   正在生成第 N 章。
*   前文内容（Previous Content）被截取保留最后一部分（受 Context Length 限制）。
*   用户勾选了“发送完整大纲上下文”。

**发送给 AI 的消息**:

```json
[
  {
    "role": "system",
    "content": "你是一个专业的小说家。请根据用户的要求创作小说，文笔要优美，情节要跌宕起伏。"
  },
  {
    "role": "system",
    "content": "（预设提示词...）"
  },
  {
    "role": "user",
    "content": "【前文剧情回顾】：\n（最近几千字的正文内容...）\n\n【全书大纲参考】：\n1. 第一章：标题 - 摘要\n2. 第二章：标题 - 摘要\n...\n\n你正在创作小说《小说标题》。\n当前章节：第二章：危机四伏\n本章大纲：主角在森林里迷路了，遇到了野兽。\n\n请根据大纲和前文剧情，撰写本章正文。文笔要生动流畅。"
  }
]
```

### 5. 辅助生成 (大纲/角色/世界观)

在自动化创作中心（左侧菜单）中生成设定时。

**示例：生成角色**
**发送给 AI 的消息**:

```json
[
  {
    "role": "system",
    "content": "（如果在自动化中心设置了全局提示词，会显示在这里。例如：所有角色都必须是赛博朋克风格。）"
  },
  {
    "role": "system",
    "content": "你是一个专业的小说角色设计专家。"
  },
  {
    "role": "user",
    "content": "请根据用户的要求生成或补充角色列表。\n\n【现有角色列表】：\n[\n  { \"name\": \"主角\", \"bio\": \"...\" }\n]\n\n【参考世界观 (魔法世界)】：\n[ ... ]\n\n【用户设定备注/历史输入】：\n[10:00:00] 创建一个反派\n\n【用户当前指令】：\n设计一个反派角色的手下，性格要胆小。\n\n请根据以上信息，生成新的角色（如果是修改现有角色，请返回修改后的完整信息）。\n请严格返回一个 JSON 数组..."
  }
]
```

### 6. 内容润色/优化 (Optimize)

在正文编辑页面点击“魔术棒”图标时。

**发送给 AI 的消息**:

```json
[
  {
    "role": "system",
    "content": "你是一个专业的小说编辑。请对用户提供的章节内容进行润色和优化，使其描写更生动、行文更流畅，但不要改变原意。"
  },
  {
    "role": "user",
    "content": "请优化以下小说章节内容：\n\n（当前章节的原始内容...）\n\n【用户额外指令】：\n（用户输入的具体优化要求，如：增加更多环境描写）\n\n请直接返回优化后的正文内容，不要包含任何解释。"
  }
]
```

---

## 常见问题

### Q: 为什么有时候长文模式不起作用？
A: 请确保：
1.  左下角的“长文模式”开关已打开（变为高亮色）。
2.  您的章节结构符合间隔要求（例如默认每3章需要一个小总结）。
3.  如果之前写了很多章但没有开启长文模式，请点击“全局设置” -> “长文模式设置” -> “扫描并补充缺失的总结”来生成必要的摘要数据。

### Q: 大总结和小总结的间隔可以修改吗？
A: 可以。在“全局设置” -> “长文模式设置”中，您可以自定义小总结（默认3章）和大总结（默认6章）的触发间隔。

### Q: 自动生成的总结可以修改吗？
A: 可以。总结也是一种特殊的章节。您可以在左侧章节列表中找到它们（通常以 `🔹小总结` 或 `🔸大总结` 开头），点击即可像普通章节一样进行编辑。修改后的总结将作为后续生成的上下文。
