# 修复日志 - 2024/11/01

## 问题描述

在电脑端执行工作流（Workflow）时，章节列表出现持续闪烁，且生成的章节与自动生成的总结（小总结、大总结）排序发生错乱，总结条目经常被移动到列表末尾或错误位置。

## 根本原因分析

1. **合并逻辑缺陷**：在 `App.tsx` 的 `onUpdateNovel` 回调中，合并本地章节与远程（工作流引擎返回）章节时，采用了“保留旧顺序 + 追加新章节”的策略。当自动总结任务生成新的总结章节时，这些章节被视为“新章节”追加到数组末尾，破坏了原有的“章节-总结”嵌套顺序。
2. **缺乏逻辑排序**：系统之前过度依赖数组的原始插入顺序来展示章节列表。在多任务并行更新状态时，这种顺序非常脆弱，容易因竞态条件导致错乱。
3. **频繁重绘导致的闪烁**：工作流执行时的高频状态更新触发了列表的全量重新渲染，加之排序的不稳定，导致用户感知的视觉闪烁。

## 修复措施

1. **引入稳定排序算法**：
   - 在 `src/utils/SummaryManager.ts` 中实现 `sortChapters` 函数。
   - 该函数根据总结章节的 `summaryRange` 属性（例如 `1-3`），强制将其排列在对应范围最后一章（第3章）之后。
   - 规定同一位置的排序优先级：小总结在前，大总结在后。
2. **重构状态合并逻辑**：
   - 修改 `src/App.tsx` 中 `WorkflowEditor` 和 `MobileWorkflowEditor` 的 `onUpdateNovel` 回调。
   - 在合并章节 Map 后，不再简单追加，而是统一调用 `sortChapters` 进行逻辑排序，确保无论更新频率多高，列表顺序始终符合预期。
3. **引入流式更新节流（Throttling）**：
   - 在 `src/utils/auto-write/index.ts` 的 `AutoWriteEngine` 中增加更新频率控制。
   - 流式输出期间，强制每 200ms 才触发一次 UI 状态更新，显著降低渲染负载，消除视觉上的细微抖动。
4. **渲染层兜底排序与性能优化**：
   - 在 `src/App.tsx` 的侧边栏渲染逻辑中，显式调用 `sortChapters`。这确保了即使内存状态因为某种极端竞态出现顺序异常，UI 层依然能展示出正确的业务顺序。
   - 使用 `React.useMemo` 缓存排序结果，避免因编辑器输入等不相关状态变化导致的无效计算，进一步提升 UI 响应速度。

## 验证结果

- [x] 执行工作流时，新生成的章节正确出现在分卷中。
- [x] 自动生成的总结章节紧跟在对应章节之后，不再掉落到末尾。
- [x] 排序逻辑已修正：同一位置小总结在前，大总结在后；范围越具体（起始点越靠后）越靠前。
- [x] 章节列表闪烁现象通过 `useMemo` 预分组优化彻底解决，UI 在高频更新下保持稳定。
