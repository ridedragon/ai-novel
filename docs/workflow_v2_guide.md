# AI 小说工作流引擎 V2 使用手册

## 1. 核心升级说明

工作流引擎已从简单的“线性任务列表”升级为具备逻辑判断能力的“智能执行引擎”。

### 主要改动：
- **动态分卷 (Dynamic Volume)**：支持在工作流中自动创建分卷，后续生成的章节会自动归入该新分卷，无需手动指定。
- **变量系统 (Variables)**：引入了全局上下文变量（如 `{{batch_range}}`），支持从用户输入中捕获变量，并在后续 AI 提示词中动态替换。
- **智能规划器 (Planner)**：支持架构师节点生成复杂的执行计划。

---

## 2. 新功能使用指南

### 2.1 变量绑定与使用 (Interactive Variables)

**场景**：你需要分批生成章节（如 1-10 章，11-20 章），而不是一次性写死。

1. **捕获变量**：
   - 在 **“用户输入” (User Input)** 节点中，现在不仅是暂停，还可以捕获输入。
   - (目前需通过高级配置或协议指定绑定，未来将提供图形化界面)。
   - 系统内置变量：
     - `{{loop_index}}`: 当前循环次数（如果使用了循环）。
     - `{{active_volume_anchor}}`: 当前自动创建的活跃分卷 ID。

2. **使用变量**：
   - 在任何 AI 生成节点（大纲、正文等）的 **“指令 (Instruction)”** 或 **“自定义提示词”** 中，使用双大括号语法。
   - 示例：`请为 {{batch_range}} 章节生成大纲。`
   - 运行时，引擎会自动将 `{{batch_range}}` 替换为实际值。

### 2.2 自动分卷与动态锚点 (Active Volume Anchor)

**场景**：工作流自动规划并创建了一卷“第一卷：风起云涌”，后续生成的正文需要自动放进这一卷，而不是堆在根目录。

1. **创建分卷**：
   - 使用 **“创建目录” (Create Folder)** 节点或 AI 规划器生成的新分卷。
   - 引擎会自动将这个新分卷标记为 **“活跃锚点 (Active Anchor)”**。

2. **自动归档**：
   - 后续的 **“正文生成” (Chapter)** 节点，其目标分卷设置为 **“自动匹配”** (默认)。
   - 引擎会优先寻找活跃锚点，将章节写入其中。

### 2.3 循环容器 (Loop Container) - (高级特性)

**场景**：针对大长篇，自动循环执行“大纲-正文”生成流程 10 次。

- 支持配置循环次数 `loop_count`。
- 引擎会维护 `loop_index`，你可以用 `第 {{loop_index}} 卷` 来动态生成标题。

---

## 3. 常见问题 (Q&A)

**Q: 为什么我的提示词里的 {{var}} 没有被替换？**
A: 请确保变量名拼写正确，且在前序节点中确实通过“用户输入”或“AI 输出捕获”设置了该变量。

**Q: 旧的工作流还能用吗？**
A: 完全兼容。V2 引擎向下兼容旧的线性执行模式。

**Q: 如何重置卡住的工作流？**
A: 在编辑器右上角点击“重置状态”按钮，或者切换到其他工作流再切回来。

---

## 4. 界面说明

- **节点状态灯**：
  - 🔵 蓝色呼吸：正在执行。
  - 🟢 绿色常亮：执行完成。
  - 🔴 红色边框：执行出错。
  
- **连线动画**：执行时，连线会有光流效果指示数据流向。