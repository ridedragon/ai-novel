# 📝 第一次修改日志 - 20241101

针对 [`排查报告_手机端操作卡顿_20241101.md`](排查报告_手机端操作卡顿_20241101.md) 中提出的问题，进行了第一次性能优化修复。

## 1. 状态下沉 (State Sinking)

* **问题**：`isMobileSidebarOpen` 状态定义在 [`src/App.tsx`](src/App.tsx) 根部，导致每次切换侧边栏都会触发整个 App 的重绘。
* **修复**：
  * 创建了 [`src/contexts/LayoutContext.tsx`](src/contexts/LayoutContext.tsx)，用于管理 UI 布局相关的局部状态。
  * 在 [`src/main.tsx`](src/main.tsx) 中引入了 `LayoutProvider`。
  * 将 [`src/App.tsx`](src/App.tsx) 中的 `isMobileSidebarOpen` 状态替换为 `useLayout()` 钩子调用。
* **预期效果**：切换侧边栏时，不再触发 App 根组件及其庞大子树的无效渲染。

## 2. CSS 硬件加速 (Hardware Acceleration)

* **问题**：侧边栏动画在低端设备上存在掉帧现象。
* **修复**：
  * 在 [`src/index.css`](src/index.css) 中添加了 `will-change-transform` 工具类。
  * 在 [`src/App.tsx`](src/App.tsx) 的侧边栏容器上应用了该类，强制浏览器开启 GPU 加速。
* **预期效果**：侧边栏滑动动画更加丝滑。

## 3. 文件变更列表

1. [`src/contexts/LayoutContext.tsx`](src/contexts/LayoutContext.tsx) (新增)
2. [`src/main.tsx`](src/main.tsx) (修改)
3. [`src/App.tsx`](src/App.tsx) (修改)
4. [`src/index.css`](src/index.css) (修改)

# 📝 第二次修改日志 - 20241101

修复了在运行工作流时出现的 `TypeError: Cannot read properties of undefined (reading 'map')` 运行时崩溃问题。

## 1. 核心问题修复：运行时防御逻辑

* **问题**：工作流引擎在高频同步数据时，可能传入 `undefined` 或 `null` 的列表数据（如 `chapters`、`versions`、`volumes`），导致原本直接调用 `.map()` 的逻辑崩溃。
* **修复**：
  * **[`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts)**：
    * 在 `sortChapters` 函数入口处添加了数组类型检查。
    * 在 `checkAndGenerateSummary` 中为 `currentNovel.chapters` 调用添加了 `|| []` 防御逻辑。
    * 对 `currentChaptersSnapshot` 的消费添加了空值保护。
  * **[`src/App.tsx`](src/App.tsx)**：
    * 在 `onUpdateNovel` 回调函数中，对 `localNovel.chapters`、`updatedNovel.chapters` 以及 `combinedVersions` 的合并逻辑全面实施了空数组防御。
* **预期效果**：工作流在各种数据状态（包括冷加载、快速切换、数据异常）下均能稳定运行，不再触发此类报错。

## 2. 文件变更列表

1. [`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts) (修改)
2. [`src/App.tsx`](src/App.tsx) (修改)

# 📝 第三次修改日志 - 20241101

针对“全自动正文创作”和工作流中“正文生成”节点在生成过程中出现的严重卡顿问题，进行了深度性能优化。

## 1. 渲染与状态合并算法优化 (O(N) 优化)

* **问题**：在工作流流式更新（每 200ms 一次）时，`WorkflowEditor` 会执行 `volumes.find` 来合并分卷折叠状态。在分卷和章节较多时，这种 O(N^2) 的操作会导致主线程阻塞，产生明显卡顿。
* **修复**：
  * 在 [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) 中引入了 `Map` 结构来缓存旧的分卷状态。
  * 将合并逻辑优化为 O(N)，显著降低了大对象更新时的 CPU 负载。
  * 仅在 `isRunning` (执行中) 状态下强制 yield 主线程，确保流式输出时 UI 保持高响应性。

## 2. 核心引擎正则性能优化 (预编译策略)

* **问题**：`AutoWriteEngine` 的 `splitBatchContent` 在流式输出的每一帧都会重新创建正则表达式来寻找章节锚点，造成了大量重复计算和内存抖动。
* **修复**：
  * 在 [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) 中实现了正则预编译。
  * 在流式循环开始前预先生成所有章节标题的匹配模式，并在循环中重用。

## 3. 任务调度时间分片细化 (16ms 颗粒度)

* **问题**：正则脚本处理 (`applyRegexToText`) 的时间分片阈值为 50ms，容易跨越多个渲染帧导致掉帧。
* **修复**：
  * 在 [`src/utils/auto-write/core.ts`](src/utils/auto-write/core.ts) 中将 `yield` 阈值从 50ms 降至 16ms。
  * 确保了正则处理与显示器刷新率（60fps）更好的同步，减少长文本处理时的视觉卡顿。

## 4. 文件变更列表

1. [`src/utils/auto-write/core.ts`](src/utils/auto-write/core.ts) (修改)
2. [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) (修改)
3. [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) (修改)
4. [`修改日志.md`](修改日志.md) (修改)

# 📝 第四次修改日志 - 20241101

修复了切换章节时显示的内容不是最新优化版本的问题。

## 1. 章节内容加载逻辑修复 (状态同步)

* **问题**：在切换章节时，系统虽然会异步加载该章节的版本历史，但加载完成后仅更新了 `versions` 数组，没有同步更新活跃版本 ID (`activeVersionId`) 和正文内容 (`content`)。这导致用户看到的始终是初次进入时的正文（通常是原文），必须手动切换版本才能看到优化后的内容。
* **修复**：
  * 在 [`src/App.tsx`](src/App.tsx) 的章节切换 `useEffect` 逻辑中，当异步获取版本历史成功后：
    * 调用 `ensureChapterVersions` 确保版本状态（如 `activeVersionId`）已根据历史记录正确初始化。
    * 显式将 `content` 设置为活跃版本的内容。
* **预期效果**：切换到已优化章节时，系统会自动选中并显示最新的优化版本，不再需要用户手动切换。

## 2. 文件变更列表

1. [`src/App.tsx`](src/App.tsx) (修改)
2. [`修改日志.md`](修改日志.md) (修改)

# 📝 第五次修改日志 - 20241101

修复了长文模式下选择“仅当前卷”时，大总结（Big Summary）依然包含其他分卷内容，导致总结范围异常的问题。

## 1. 总结生成逻辑修复 (作用域隔离)

* **问题**：在大总结生成逻辑中，代码硬编码了从第 1 章开始累积，且在寻找历史总结和构建上下文时未考虑分卷过滤条件。这导致即使设置了“仅当前卷”，AI 获取的上下文依然包含全书历史，生成的总结范围始终从 1 开始。
* **修复**：
  * **[`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts)**：
    * 扩展了 `SummaryConfig` 接口，引入 `contextScope` 参数。
    * 修改 `generate` 函数：
      * 在构建大总结上下文时，将小总结的过滤范围从 `1` 改为 `start`。
      * 在寻找最近大总结时，将匹配范围起点从 `1` 改为 `start`。
      * 在提取正文原文时，将回看起点限制在 `start` 之后。
    * 修改 `checkAndGenerateSummary` 触发逻辑：根据 `contextScope` 动态计算 `globalStart`。如果是“仅当前卷”或指定分卷，起点自动调整为该卷的第一章。
  * **[`src/App.tsx`](src/App.tsx)**：
    * 在调用 `checkAndGenerateSummary` 时同步传入当前的 `contextScope` 状态。
    * 同步修复了“扫描总结”功能，确保手动触发扫描时也遵循当前的分卷过滤规则。
* **预期效果**：长文模式下选择“仅当前卷”后，新生成的总结将严格限制在当前卷范围内，大总结的范围标签也将正确显示为“当前卷起始章-当前章”。

## 2. 文件变更列表

1. [`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts) (修改)
2. [`src/App.tsx`](src/App.tsx) (修改)
3. [`修改日志.md`](修改日志.md) (修改)
