# 📝 第一次修改日志 - 20241101

针对 [`排查报告_手机端操作卡顿_20241101.md`](排查报告_手机端操作卡顿_20241101.md) 中提出的问题，进行了第一次性能优化修复。

## 1. 状态下沉 (State Sinking)

* **问题**：`isMobileSidebarOpen` 状态定义在 [`src/App.tsx`](src/App.tsx) 根部，导致每次切换侧边栏都会触发整个 App 的重绘。
* **修复**：
  * 创建了 [`src/contexts/LayoutContext.tsx`](src/contexts/LayoutContext.tsx)，用于管理 UI 布局相关的局部状态。
  * 在 [`src/main.tsx`](src/main.tsx) 中引入了 `LayoutProvider`。
  * 将 [`src/App.tsx`](src/App.tsx) 中的 `isMobileSidebarOpen` 状态替换为 `useLayout()` 钩子调用。
* **预期效果**：切换侧边栏时，不再触发 App 根组件及其庞大子树的无效渲染。

## 2. CSS 硬件加速 (Hardware Acceleration)

* **问题**：侧边栏动画在低端设备上存在掉帧现象。
* **修复**：
  * 在 [`src/index.css`](src/index.css) 中添加了 `will-change-transform` 工具类。
  * 在 [`src/App.tsx`](src/App.tsx) 的侧边栏容器上应用了该类，强制浏览器开启 GPU 加速。
* **预期效果**：侧边栏滑动动画更加丝滑。

## 3. 文件变更列表

1. [`src/contexts/LayoutContext.tsx`](src/contexts/LayoutContext.tsx) (新增)
2. [`src/main.tsx`](src/main.tsx) (修改)
3. [`src/App.tsx`](src/App.tsx) (修改)
4. [`src/index.css`](src/index.css) (修改)

# 📝 第二次修改日志 - 20241101

修复了在运行工作流时出现的 `TypeError: Cannot read properties of undefined (reading 'map')` 运行时崩溃问题。

## 1. 核心问题修复：运行时防御逻辑

* **问题**：工作流引擎在高频同步数据时，可能传入 `undefined` 或 `null` 的列表数据（如 `chapters`、`versions`、`volumes`），导致原本直接调用 `.map()` 的逻辑崩溃。
* **修复**：
  * **[`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts)**：
    * 在 `sortChapters` 函数入口处添加了数组类型检查。
    * 在 `checkAndGenerateSummary` 中为 `currentNovel.chapters` 调用添加了 `|| []` 防御逻辑。
    * 对 `currentChaptersSnapshot` 的消费添加了空值保护。
  * **[`src/App.tsx`](src/App.tsx)**：
    * 在 `onUpdateNovel` 回调函数中，对 `localNovel.chapters`、`updatedNovel.chapters` 以及 `combinedVersions` 的合并逻辑全面实施了空数组防御。
* **预期效果**：工作流在各种数据状态（包括冷加载、快速切换、数据异常）下均能稳定运行，不再触发此类报错。

## 2. 文件变更列表

1. [`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts) (修改)
2. [`src/App.tsx`](src/App.tsx) (修改)

# 📝 第三次修改日志 - 20241101

针对“全自动正文创作”和工作流中“正文生成”节点在生成过程中出现的严重卡顿问题，进行了深度性能优化。

## 1. 渲染与状态合并算法优化 (O(N) 优化)

* **问题**：在工作流流式更新（每 200ms 一次）时，`WorkflowEditor` 会执行 `volumes.find` 来合并分卷折叠状态。在分卷和章节较多时，这种 O(N^2) 的操作会导致主线程阻塞，产生明显卡顿。
* **修复**：
  * 在 [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) 中引入了 `Map` 结构来缓存旧的分卷状态。
  * 将合并逻辑优化为 O(N)，显著降低了大对象更新时的 CPU 负载。
  * 仅在 `isRunning` (执行中) 状态下强制 yield 主线程，确保流式输出时 UI 保持高响应性。

## 2. 核心引擎正则性能优化 (预编译策略)

* **问题**：`AutoWriteEngine` 的 `splitBatchContent` 在流式输出的每一帧都会重新创建正则表达式来寻找章节锚点，造成了大量重复计算和内存抖动。
* **修复**：
  * 在 [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) 中实现了正则预编译。
  * 在流式循环开始前预先生成所有章节标题的匹配模式，并在循环中重用。

## 3. 任务调度时间分片细化 (16ms 颗粒度)

* **问题**：正则脚本处理 (`applyRegexToText`) 的时间分片阈值为 50ms，容易跨越多个渲染帧导致掉帧。
* **修复**：
  * 在 [`src/utils/auto-write/core.ts`](src/utils/auto-write/core.ts) 中将 `yield` 阈值从 50ms 降至 16ms。
  * 确保了正则处理与显示器刷新率（60fps）更好的同步，减少长文本处理时的视觉卡顿。

## 4. 文件变更列表

1. [`src/utils/auto-write/core.ts`](src/utils/auto-write/core.ts) (修改)
2. [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) (修改)
3. [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) (修改)
4. [`修改日志.md`](修改日志.md) (修改)

# 📝 第四次修改日志 - 20241101

修复了切换章节时显示的内容不是最新优化版本的问题。

## 1. 章节内容加载逻辑修复 (状态同步)

* **问题**：在切换章节时，系统虽然会异步加载该章节的版本历史，但加载完成后仅更新了 `versions` 数组，没有同步更新活跃版本 ID (`activeVersionId`) 和正文内容 (`content`)。这导致用户看到的始终是初次进入时的正文（通常是原文），必须手动切换版本才能看到优化后的内容。
* **修复**：
  * 在 [`src/App.tsx`](src/App.tsx) 的章节切换 `useEffect` 逻辑中，当异步获取版本历史成功后：
    * 调用 `ensureChapterVersions` 确保版本状态（如 `activeVersionId`）已根据历史记录正确初始化。
    * 显式将 `content` 设置为活跃版本的内容。
* **预期效果**：切换到已优化章节时，系统会自动选中并显示最新的优化版本，不再需要用户手动切换。

## 2. 文件变更列表

1. [`src/App.tsx`](src/App.tsx) (修改)
2. [`修改日志.md`](修改日志.md) (修改)

# 📝 第五次修改日志 - 20241101

修复了长文模式下选择“仅当前卷”时，大总结（Big Summary）依然包含其他分卷内容，导致总结范围异常的问题。

## 1. 总结生成逻辑修复 (作用域隔离)

* **问题**：在大总结生成逻辑中，代码硬编码了从第 1 章开始累积，且在寻找历史总结和构建上下文时未考虑分卷过滤条件。这导致即使设置了“仅当前卷”，AI 获取的上下文依然包含全书历史，生成的总结范围始终从 1 开始。
* **修复**：
  * **[`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts)**：
    * 扩展了 `SummaryConfig` 接口，引入 `contextScope` 参数。
    * 修改 `generate` 函数：
      * 在构建大总结上下文时，将小总结的过滤范围从 `1` 改为 `start`。
      * 在寻找最近大总结时，将匹配范围起点从 `1` 改为 `start`。
      * 在提取正文原文时，将回看起点限制在 `start` 之后。
    * 修改 `checkAndGenerateSummary` 触发逻辑：根据 `contextScope` 动态计算 `globalStart`。如果是“仅当前卷”或指定分卷，起点自动调整为该卷的第一章。
  * **[`src/App.tsx`](src/App.tsx)**：
    * 在调用 `checkAndGenerateSummary` 时同步传入当前的 `contextScope` 状态。
    * 同步修复了“扫描总结”功能，确保手动触发扫描时也遵循当前的分卷过滤规则。
* **预期效果**：长文模式下选择“仅当前卷”后，新生成的总结将严格限制在当前卷范围内，大总结的范围标签也将正确显示为“当前卷起始章-当前章”。

## 2. 文件变更列表

1. [`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts) (修改)
2. [`src/App.tsx`](src/App.tsx) (修改)
3. [`修改日志.md`](修改日志.md) (修改)

# 📝 第六次修改日志 - 20241101

修复了点击已优化章节时显示原版内容的 bug，确保点击后默认显示最新的优化版本。

## 1. 章节切换逻辑增强 (版本自动锁定)

* **问题**：在侧边栏点击已完成润色的章节时，系统默认加载的是内存中的初始内容（通常是原版），即使用户之前已经完成了多次润色。用户必须点击版本切换按钮才能看到优化后的结果，这不符合“点击即看最新结果”的交互习惯。
* **修复**：
  * 修改了 **[`src/App.tsx`](src/App.tsx)** 中监听 `activeChapterId` 的 `useEffect` 逻辑：
    * 移除了“仅在内存版本为空时才加载”的限制，改为每次切换章节都触发版本检查。
    * 在获取到版本历史后，增加了 `optimizingChapterIds.has(c.id)` 的安全检查，确保不会干扰正在进行的流式润色任务。
    * 自动计算历史记录中的最新版本（数组最后一个元素），并强制将 `activeVersionId` 切换至该版本。
    * 同步更新 `content` 属性，确保编辑器显示的文字与选中的版本 ID 严格一致。
* **预期效果**：用户点击任何已经润色过的章节，都会直接进入并显示最新的优化成果，无需额外操作。

## 2. 文件变更列表

1. [`src/App.tsx`](src/App.tsx) (修改)
2. [`修改日志.md`](修改日志.md) (修改)

# 📝 第七次修改日志 - 20241101

修复了章节总数显示正确但列表为空的严重 Bug，解决了章节在特定情况下“隐身”的问题。

## 1. 章节分组逻辑健壮性增强 (消除渲染盲区)

* **问题**：侧边栏的章节列表渲染依赖于 `volumes`（分卷）数组。如果某个章节携带了无效的 `volumeId`（例如该分卷已被删除，或由于数据迁移导致的 ID 不匹配），该章节会被归类到一个在 UI 上没有对应渲染入口的分组中。由于它既不属于“有效分卷”，也不属于“未分卷（uncategorized）”，导致这些章节虽然存在于内存中（总数统计正确），但在界面上完全不可见。
* **修复**：
  * 修改了 **[`src/App.tsx`](src/App.tsx)** 中的 `chaptersByVolume` 计算逻辑。
  * 引入了 `validVolumeIds` 集合进行实时校验。
  * 在分组时增加预检：只有当章节的 `volumeId` 确实存在于当前书籍的 `volumes` 列表中时，才按分卷归类；否则，强制将其归类到 `uncategorized`（未分卷）列表中。
* **预期效果**：所有章节无论其分卷信息是否异常，都至少能在“未分卷”列表中显示出来，彻底杜绝章节隐身现象，确保用户数据的可见性。

## 2. 文件变更列表

1. [`src/App.tsx`](src/App.tsx) (修改)
2. [`修改日志.md`](修改日志.md) (修改)

# 📝 第八次修改日志 - 20241101

修复了分卷（Volumes）名称在侧边栏丢失、文件夹图标消失以及章节归类异常的问题。

## 1. 存储层分卷数据保护

* **问题**：在 [`src/utils/storage.ts`](src/utils/storage.ts) 的原子化保存逻辑中，`volumes` 属性被错误地从书籍“骨架”对象中剥离。这导致应用冷启动时，在异步加载完整元数据之前，书籍状态中不包含任何分卷信息。
* **后果**：由于第七次修改引入了分卷 ID 合法性校验，缺失分卷信息的书籍会将所有章节强制归类为“未分卷”，导致侧边栏的卷文件夹完全消失。
* **修复**：修改了 `strippedNovels` 的映射逻辑，确保 `volumes` 始终保留在主书籍列表中。

## 2. 桌面端工作流合并逻辑同步

* **问题**：桌面端 [`WorkflowEditor`](src/components/WorkflowEditor.tsx) 的 `onUpdateNovel` 回调函数在合并数据时，没有像移动端那样显式保留分卷的折叠状态 (`collapsed`)，且存在覆盖 `volumes` 数组的风险。
* **修复**：在 [`src/App.tsx`](src/App.tsx) 的桌面端工作流更新逻辑中，引入了与移动端一致的智能合并算法，确保分卷信息及其 UI 状态在自动化生成过程中保持稳定。

## 3. 增强型分卷数据找回 (Data Healing)

* **功能**：针对已经发生分卷名称丢失的数据，在 [`src/App.tsx`](src/App.tsx) 的书籍加载钩子中增加了跨源找回与自动修复逻辑。
* **修复 ID 匹配失效**：解决了 ID 类型不一致（String 与 UUID 对象/数字）导致的找回逻辑失效问题，现在统一进行强制字符串校验。
* **三级修复路径**：
    1. **工作流同步**：从 `novel_workflows` 配置中提取节点定义的目录名。
    2. **资料集对齐**：通过 ID 匹配大纲、世界观等资料集的名称。
    3. **占位恢复**：如果以上路径均失效，系统将自动创建一个“恢复的分卷 (ID)”占位符，强制恢复侧边栏的分层结构，确保章节不再被错误归类到“未分卷”底部。

## 4. 章节渲染逻辑增强

* **修复 ID 匹配容错**：在侧边栏渲染分组逻辑中，强制将分卷 ID 转换为字符串比对。这解决了因 ID 类型不一致（数字 vs 字符串）导致的章节无法正确归位至分卷文件夹的问题。

## 5. 文件变更列表

1. [`src/utils/storage.ts`](src/utils/storage.ts) (修改)
2. [`src/App.tsx`](src/App.tsx) (修改)
3. [`修改日志.md`](修改日志.md) (修改)

# 📝 第九次修改日志 - 20241101

修复了中止工作流并删除分卷后，重新执行工作流导致旧章节“复活”并产生乱序的问题。

## 1. 工作流初始化状态清理 (防止 ID 残留)

* **问题**：工作流中的“正文生成”节点会将生成的 `targetVolumeId` 持久化在缓存中。当用户全量重新运行工作流时，旧的 ID 关联没有被清空。
* **后果**：系统启动时的 Data Healing 机制会通过这个残留的旧 ID 找回数据库中未彻底删除的“孤儿章节”，导致已删除的旧分卷以“恢复的分卷”形式复活，并与新生成的章节发生冲突（因标题一致而导致覆盖写入）。
* **修复**：在 [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) 的 `runWorkflow` 函数中，当 `startIndex === 0`（全量运行）时，强制清空所有节点的执行期状态，包括 `targetVolumeId`、`targetVolumeName` 和 `outputEntries`。

## 2. 存储层物理删除能力增强 (斩断复活路径)

* **问题**：存储层 `saveNovels` 仅有增量写入逻辑，当章节被从书籍数组中移除时，其在 IndexedDB 中的正文块和版本块并未被物理删除，留下了“复活”的隐患。
* **修复**：
  * 在 [`src/utils/storage.ts`](src/utils/storage.ts) 中增加了 `deleteChapterContent` 接口，显式调用 `idb-keyval` 的 `del` 方法。
  * 在 [`src/App.tsx`](src/App.tsx) 的 `handleDeleteVolume`（删除分卷）和 `handleDeleteChapter`（删除章节）逻辑中，增加了显式的物理删除与**级联清理**。
* **级联清理 (Cascade Delete)**：当删除剧情章节或分卷时，系统现在会自动识别并物理清理掉那些失去归属的“小总结”和“大总结”章节，防止它们作为“孤儿总结”残留在侧边栏或数据库中。
* **预期效果**：被用户删除的分卷及其关联的自动生成产物（正文、总结）将从内存和数据库中同步彻底抹除。

## 3. 文件变更列表

1. [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) (修改)
2. [`src/utils/storage.ts`](src/utils/storage.ts) (修改)
3. [`src/App.tsx`](src/App.tsx) (修改)
4. [`修改日志.md`](修改日志.md) (修改)

# 📝 第十次修改日志 - 20241101

针对 `storage.saveNovels` 引起的浏览器卡死问题，进行了深度原子化存储优化。

## 1. 灵感集 (InspirationSets) 原子化拆分

* **问题**：灵感集中包含了大量的 AI 聊天历史数据。在之前的逻辑中，这部分数据未从全局书籍列表（Skeleton）中剥离。导致每次保存时，主线程需要同步序列化数 MB 甚至数十 MB 的 JSON 数据，直接造成 UI 卡死（用户报告耗时约 1.4s）。
* **修复**：
  * 在 [`src/utils/storage.ts`](src/utils/storage.ts) 中为 `InspirationSets` 增加了独立存储前缀 `novel_inspiration_`。
  * 在全局列表剥离逻辑中增加了 `inspirationSets` 排除项。
  * 实现了针对灵感集的脏检查（Dirty Check），仅在内容实际变化时才触发数据库写入。
* **预期效果**：全局索引 JSON 体积缩减 90% 以上，主线程序列化耗时降至毫秒级，彻底消除保存时的卡顿感。

## 2. 元数据冗余精简

* **问题**：单本书的元数据（Metadata）中完整存储了每一章的 AI 分析结果（analysisResult）。对于章节数较多的书籍，这会导致元数据块异常沉重。
* **修复**：在保存元数据时，对 `analysisResult` 进行了截断处理（仅保留前 100 字符作为摘要），完整数据由各章独立的存储块承载。

## 3. 文件变更列表

1. [`src/utils/storage.ts`](src/utils/storage.ts) (修改)
2. [`修改日志.md`](修改日志.md) (修改)

# 📝 第十一次修改日志 - 20241101

修复了工作流正文生成后的后台润色任务在分析阶段报错 `Analysis failed: Error: Request was aborted.` 导致章节优化无法完成的问题。

## 1. 优化任务分析阶段错误处理修复

* **问题**：在 `AutoWriteEngine.optimizeChapter` 的第一阶段（分析阶段），代码未能像第二阶段（优化/润色阶段）那样正确识别并捕获 `AbortError`。这导致当任务被中止（无论是由于网络抖动还是引擎内部状态切换）时，会抛出非预期的错误日志，且可能干扰后续逻辑。
* **修复**：在 [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) 的分析阶段 `try-catch` 块中增加了对 `AbortError`、`Request was aborted.` 和 `Aborted` 消息的识别逻辑。现在中止操作将被视为正常流程并记录日志，而非作为严重错误上报。

## 2. 工作流组件卸载逻辑优化

* **问题**：在 [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) 中，原有的 `useEffect` 清理逻辑在组件卸载时会无条件调用 `stopWorkflow()`。由于该组件是在弹窗关闭时即刻卸载的，这导致即便开启了保活，后台的润色任务也会因为 `AbortController.abort()` 的调用而被强制终止。
* **修复**：调整了 `WorkflowEditor` 的卸载逻辑。现在在检测到非用户手动点击“停止”导致的中止（如关闭弹窗导致的组件卸载）时，不再主动调用 `stopWorkflow()`。这允许后台运行的任务（如润色、总结）在弹窗关闭后继续在内存中完成，真正实现了“后台运行”的承诺。

## 3. 文件变更列表

1. [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) (修改)
2. [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) (修改)
3. [`修改日志.md`](修改日志.md) (修改)
