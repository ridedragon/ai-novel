# AI 小说生成器项目计划书 - 第三部分：长效记忆与技术实现方案

## 3.1 核心挑战：长文本一致性（Consistency）

在长篇小说创作中，最大的技术挑战在于“如何让 AI 记住 50 万字以前设定的伏笔”。即使模型支持 128k 甚至 1M 的上下文窗口，仅仅依靠“塞入所有文字”也是低效且不稳定的（容易出现 Attention Sink 或对中间内容的遗忘）。

我们提出一套**“多层级联记忆架构”**，从四个维度解决一致性问题：

## 3.2 多层级联记忆架构设计

### 3.2.1 第一层：工作记忆（Working Memory）—— 当前焦点

* **内容**：当前正在创作的段落、上一章的最后 2000 字、以及由“导演 Agent”下达的本章写作指令。
* **实现**：直接通过 API 的上下文窗口（Context Window）传递。

### 3.2.2 第二层：递归摘要记忆（Summary Memory）—— 剧情流

* **内容**：全书大纲、分卷总结、以及前三章的细化摘要。
* **实现**：
  * 利用现有的 [`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts) 机制。
  * **改进点**：实现“摘要树”架构。第 1-5 章总结为摘要 A，第 6-10 章总结为摘要 B，A 和 B 再次总结为卷一摘要。这种分层摘要能在不占用过多 Token 的前提下，让 AI 把握剧情脉络。

### 3.2.3 第三层：结构化知识记忆（Structured Memory）—— 设定集

* **内容**：
  * **角色卡**：不仅是静态描述，还包含角色的“经历轨迹”、“当前状态”（如：负伤、已黑化）。
  * **世界观**：地理位置关系、力量分级、特有名词解释。
* **实现**：
  * 基于 [`src/types.ts`](src/types.ts) 中的 `CharacterSet` 和 `WorldviewSet`。
  * **技术方案**：Graph-RAG（知识图谱 + RAG）。利用图数据库（如 Neo4j）存储角色间的社会关系，确保“敌人的敌人是朋友”这类复杂逻辑不崩坏。

### 3.2.4 第四层：语义检索记忆（Semantic Memory）—— 全文 RAG

* **内容**：全书所有已生成的原始文本。
* **实现**：
  * **Embedding**：使用向量化模型（如 OpenAI text-embedding-3-small）将文本分块存入向量数据库（Vector DB，如 Pinecone 或本地的 IndexedDB + Vector Plugin）。
  * **Retrieval**：当“质检 Agent”检测到某个新情节时，自动检索库中相似的历史片段，进行逻辑碰撞。

## 3.3 Agent 编排技术选型

### 3.3.1 状态机与工作流框架

我们计划弃用简单的线性提示词堆叠，采用类似 **LangGraph** 的有向无环图（DAG）编排逻辑：

* **节点（Node）**：每个 Agent 作为一个节点。
* **边（Edge）**：定义任务流转条件（如：`if CriticScore < 80 then return to WriterAgent`）。
* **持久化层**：利用 Redis 或浏览器 IndexedDB 存储每个创作会话的 Agent 状态。

### 3.3.2 动态提示词（Dynamic Prompts）机制

在 [`src/App.tsx`](src/App.tsx) 的基础上，引入“提示词编译器”：

1. **解析器**：识别 `{{character_name}}`、`{{last_location}}` 等标签。
2. **注入器**：在发送请求前，从“结构化记忆”中实时抓取最新设定并填入。

## 3.4 性能与成本控制方案

多 Agent 系统必然带来 Token 消耗的激增。我们将实施以下优化：

1. **缓存策略**：对于不常变动的工作（如：设定 RAG 的 Embedding），在本地 IndexedDB 中进行长期缓存。
2. **模型分级**：
    * **创作 Agent**：使用 GPT-4o 或 Claude 3.5 Sonnet（高质量输出）。
    * **摘要/质检 Agent**：使用 GPT-4o-mini 或 DeepSeek-V3（高性价比）。
    * **本地 Agent**：对于简单的正则处理或格式检查，直接在浏览器端运行轻量级模型。

## 3.5 前端架构演进

为了配合 Agent 系统，[`src/App.tsx`](src/App.tsx) 需要进行组件化拆分：

* **Agent 监控台**：实时显示“导演 Agent”正在调度哪个子 Agent，显示它们的博弈过程。
* **冲突高亮组件**：当“质检 Agent”发现逻辑矛盾时，在正文中以红色下划线标注，并弹出“修改建议卡片”。

---
*注：本篇章明确了技术落地方向，下一篇将讨论具体的功能迭代 Roadmap。*
