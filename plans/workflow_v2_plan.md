# 工作流重构计划书 (Workflow V2)

## 1. 核心目标：从“线性执行”到“逻辑引擎”

当前的系统是一个简单的任务执行器。重构后的 V2 架构将升级为一个具备**逻辑控制**、**动态插值**、**上下文锚点**和**交互式状态管理**的智能执行引擎。

## 2. 针对创作者痛点的专项解决方案

### 痛点 1：100+ 章节导致节点爆炸，修改麻烦

- **方案**：**循环块 (Loop Container)**。
- **细节**：
  - 引入容器节点，利用 React Flow 的 Parent/Child 机制。用户只需创建一个“循环块”，将“大纲+正文”节点放入其中。
  - **动态计数**：循环块支持 `loop_count` 变量，该变量可由前置节点动态修改（例如规划器算出有 10 卷，则循环 10 次）。

### 痛点 2：无法自动分卷，创建目录后仍需手动操作

- **方案**：**动态规划器 (Dynamic Planner) 与 指令路由 (Command Routing)**。
- **实现**：
  - **动态指令**：引入 `dynamicPlanner` 节点。它负责输出包含分卷指令的 JSON。
  - **信号执行**：引擎解析 AI 输出，检测到 `CREATE_VOLUME` 信号时，自动创建分卷，并将新分卷 ID 注入执行上下文。

### 痛点 3：目录复用与分卷逻辑混淆

- **方案**：**活跃分卷锚点 (Active Volume Anchor)**。
- **核心逻辑**：
  - **锚点锁定**：当 `dynamicPlanner` 创建新卷后，引擎会产生一个 `active_volume_anchor` 变量。
  - **动态路由**：后续节点的“目标分卷”设置为 `{{use_active_anchor}}`。执行时，正文节点不再去读取静态配置，而是动态寻找当前上下文中的“活跃锚点”，从而确保规划的章节永远出现在对应的分卷中。

### 痛点 4：分批发送命令不灵活，全局配置无法处理动态范围

- **方案**：**交互式变量捕获 (Interactive Vars) 与 循环中断机制**。
- **细节实现**：
    1. **变量捕获**：改造 `userInput` 节点，支持将用户输入实时绑定到上下文变量（如 `{{batch_range}}`）。
    2. **进度感知**：引擎内置 `{{last_index}}` 状态变量，自动追踪已生成的最高章节号。
    3. **交互式循环**：在 `Loop` 节点增加 `wait_per_iteration` 属性。
       - **场景**：用户设定分批创作。第一步遇到 `userInput`，系统暂停。用户输入“1-12”，该值注入 `{{batch_range}}`。
       - 后续节点指令：“请为 {{batch_range}} 生成大纲...”。
       - 该轮完成后，引擎自动回到 `userInput` 节点并暂停，等待用户输入“13-24”。
    4. **提示词编辑器**：在节点层面提供模板选择器，允许用户在保持 JSON 协议占位符的前提下，自由编辑针对该批次的 Prompt。

---

## 3. 技术实施路线

### 模块 A：数据协议升级 (`src/types.ts`)

- 扩展 `WorkflowNodeData`：增加 `isContainer`, `loopConfig`, `targetVolumeMode` 和 `variableBinding`。
- 定义 `WorkflowData` V2 版本：增加全局变量字典 `globalVariables`。

### 模块 B：执行引擎重构 (`src/utils/WorkflowManager.ts`)

- **栈式状态机**：重构 `runWorkflow`。支持执行堆栈，用于处理嵌套 Loop 和子节点。
- **上下文总线 (Context Bus)**：每个运行分支持有一个 `ExecutionContext`，用于存储 `active_volume_anchor`、`batch_range` 等动态变量。
- **插值处理器**：在 AI 调用前完成所有变量的动态替换。

### 模块 C：UI 交互升级 (`src/components/WorkflowEditor.tsx`)

- **容器渲染**：支持 Parent/Child 节点展示。
- **交互式弹窗**：实现工作流执行过程中的“中间态输入” UI。
- **预设库**：增加“逻辑预设”选择器，提供标准的规划协议提示词。

---

## 4. 任务分解 (Roadmap)

1. **[协议与模型]**：定义支持锚点、变量绑定和交互模式的 V2 协议。
2. **[交互式引擎]**：实现支持上下文透传和“执行中暂停”的状态机。
3. **[规划器与变量系统]**：开发 `dynamicPlanner` 节点及 `userInput` 的变量绑定功能。
4. **[锚点与路由]**：实现“活跃分卷锚点”的自动更新与精准存取。
5. **[UI 增强]**：开发全局变量面板、节点模板编辑器和交互式输入弹窗。
