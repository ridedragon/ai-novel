# 预设独立 API 配置功能计划书

## 1. 需求分析

用户希望在**部分** API 请求的预设界面中添加一个功能，允许为每个预设单独配置 API 设置（URL, API Key, 模型列表）。
**注意：** "对话补全源"（正文生成/补全）**不需要**独立 API 设置，因为主设置已经包含。
**需要添加**该功能的模块包括：
1.  世界观预设
2.  角色集预设
3.  大纲预设
4.  优化预设（修复现有界面问题）
5.  分析预设（新增）

UI 交互要求：独立 API 设置应默认隐藏，通过一个按钮或开关（如图一所示）展开显示。

## 2. 核心变更

### 2.1 数据结构 (已存在)

`PresetApiConfig` 和 `GeneratorPreset` 接口已存在于代码中，无需修改。
`CompletionPreset` 虽然有该字段，但根据新需求，UI 上将不予显示/使用。

```typescript
interface PresetApiConfig {
  apiKey?: string
  baseUrl?: string
  model?: string
  modelList?: string[]
}
```

### 2.2 UI 界面变更

1.  **删除：对话补全源设置模态框 (`showAdvancedSettings`)**
    *   **移除** 现有的 "独立 API 配置 (可选)" 区域。

2.  **修改/修复：生成器设置模态框 (`showGeneratorSettingsModal`)**
    *   **适用范围**：大纲、角色、世界观、优化、分析。
    *   **交互优化**：确保 "独立 API 配置" 区域默认折叠，点击按钮后展开。
    *   **样式修复**：修复优化界面中点击展开后内容为空或看不清（白色背景/文字问题）的 Bug。
    *   **新增覆盖**：确保 "分析阶段设置" 也能正常显示此配置区域。

### 2.3 逻辑变更 (API 调用)

确保以下函数正确使用预设中的 API 配置（如果存在）：

1.  `handleGenerateOutline` (大纲)
2.  `handleGenerateCharacters` (角色)
3.  `handleGenerateWorldview` (世界观)
4.  `handleOptimize` (润色/优化 - 包括分析阶段)
    *   分析阶段 (`twoStepOptimization` 为 true 时) 也需要使用 Analysis Preset 中的 API 配置。

**配置获取逻辑:**
优先使用 `preset.apiConfig`，缺失字段回退到全局设置。

## 3. 实施步骤

1.  **更新 `src/App.tsx`**:
    *   在 `showAdvancedSettings` (对话补全设置) 中**移除**独立 API 配置的 UI 代码。
    *   在 `showGeneratorSettingsModal` (生成器设置) 中：
        *   检查并修复 "独立 API 配置" 按钮的展开/折叠逻辑。
        *   检查 CSS 类名，修复 "看不清/白色" 的样式问题。
        *   确保该部分代码对 `generatorSettingsType === 'analysis'` 也生效。
2.  **验证 API 调用逻辑**:
    *   检查 `handleOptimize` 中是否正确获取了 `analysisPreset` 的 `apiConfig`。
    *   检查其他生成函数 (`Outline`, `Character`, `Worldview`) 是否已正确实现配置回退逻辑。

## 4. 验收标准

*   对话补全源设置中**不再**显示独立 API 配置。
*   世界观、角色、大纲、优化、分析的设置界面中，均**显示**独立 API 配置按钮。
*   点击按钮能正常展开配置表单，背景色和文字清晰可见。
*   配置生效验证：在某个预设中配置错误的 API Key，应导致该功能调用失败，而不影响全局设置。
