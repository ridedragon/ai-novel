# AI 小说写作助手：工作流程序与函数调查报告

## 1. 核心架构概述

本项目的工作流系统采用模块化设计，主要由可视化编辑器、自动创作引擎以及配套的上下文管理工具组成。系统支持从灵感、设定、大纲到正文生成的全流程自动化执行。

## 2. 关键程序文件调查

### 2.1 可视化编辑器：[`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx)

负责工作流的构建、配置和执行流控制。

- **主要数据结构**：
  - `WorkflowNodeData`: 存储节点配置，包括关联的资料集、AI 参数、输出内容等。
  - `WorkflowData`: 存储整个工作流的节点和连线关系。
- **核心逻辑函数**：
  - [`getOrderedNodes()`](src/components/WorkflowEditor.tsx:1604): 使用拓扑排序算法根据连线关系确定执行顺序。
  - [`runWorkflow()`](src/components/WorkflowEditor.tsx:1662): 工作流执行主循环，处理节点状态更新、上下文累积、AI 调用等。
  - [`NodePropertiesModal`](src/components/WorkflowEditor.tsx:417): 节点详细属性配置弹窗。

### 2.2 自动创作引擎：[`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts)

专门负责长篇正文生成的类 `AutoWriteEngine`。

- **核心方法**：
  - [`run()`](src/utils/auto-write/index.ts:29): 处理批量生成逻辑，支持流式输出和自动分章。
  - [`optimizeChapter()`](src/utils/auto-write/index.ts:458): 后台异步执行的正文润色任务，可能存在并发控制。
  - [`splitBatchContent()`](src/utils/auto-write/index.ts:664): 将 AI 合并输出的长文本拆分为多个章节。

### 2.3 上下文构造器：[`src/utils/auto-write/core.ts`](src/utils/auto-write/core.ts)

提供底层的数据处理函数。

- **核心函数**：
  - [`getChapterContext()`](src/utils/auto-write/core.ts:59): 构造 AI 写作所需的上下文，包含总结和前文。
  - [`applyRegexToText()`](src/utils/auto-write/core.ts:175): 应用正则表达式脚本。包含 `setTimeout(resolve, 0)` 的优化以防止阻塞主线程。
  - [`buildWorldInfoContext()`](src/utils/auto-write/core.ts:5): 提取并格式化世界观和角色设定。

### 2.4 总结管理器：[`src/utils/SummaryManager.ts`](src/utils/SummaryManager.ts)

管理章节总结的生成与排序。

- **核心函数**：
  - [`checkAndGenerateSummary()`](src/utils/SummaryManager.ts:191): 检查是否达到总结触发阈值并调用 AI 生成总结。
  - [`sortChapters()`](src/utils/SummaryManager.ts:18): 物理隔离与分卷强校验版的章节排序引擎。

### 2.5 系统辅助：[`src/utils/KeepAliveManager.ts`](src/utils/KeepAliveManager.ts)

- **功能**：通过播放静音音频和申请 `Wake Lock` 防止移动端或浏览器进入睡眠模式。

## 3. 内存与性能风险点初探 (对应浏览器内存爆炸情况)

1. **大规模对象深拷贝**：[`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) 中的 `updateLocalAndGlobal` 在每次 AI 更新时都会对整个 `Novel` 对象进行拷贝。如果小说章节极多，这会导致频繁的内存分配和 GC。
2. **流式输出更新频率**：[`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts) 中的流式处理虽然有 500ms 节流，但在多章节并行更新时仍可能产生大量渲染压力。
3. **正则处理长文本**：[`src/utils/auto-write/core.ts`](src/utils/auto-write/core.ts) 中的 `applyRegexToText` 处理超长文本时，如果正则表达式存在回溯问题或脚本过多，可能导致计算堆积。
4. **异步任务堆积**：`optimizeChapter` 是异步且后台运行的。如果 `maxConcurrentOptimizations` 设置过高，或者任务没有正确中止（AbortController），可能会累积大量的网络连接和内存占用。
5. **Canvas/ReactFlow 渲染**：工作流节点过多时，ReactFlow 的渲染开销也是一个潜在点（虽然在图片中主要表现为浏览器主进程内存高）。

## 4. 下一步行动建议

1. 检查 `src/utils/auto-write/index.ts` 中的 `optimizeChapter` 任务清理机制。
2. 分析 `Novel` 对象的大小，评估是否需要采用更细粒度的不可变数据更新。
3. 监控 `terminal.log` 的输出量，防止日志过多导致控制台内存占用过高。

## 4. 内存爆炸（GB级别）原因排查结论

根据用户提供的任务管理器截图，**浏览器主进程（Browser Process）** 占用高达 **7.6GB**，而 **渲染进程（Tab: AI小说写作助手）** 仅占用 **229MB**。这种极其罕见的偏差指向了以下深度原因：

### 4.1 GPU 与 Canvas 渲染堆栈溢出 (已经排除，不是该原因)

工作流编辑器使用了 ReactFlow，其底层依赖大量 SVG 或 Canvas 渲染。

- **排查发现**：`src/components/WorkflowEditor.tsx` 中的 `CoolEdge` 组件（218行）曾尝试通过代码注释说明移除 `filter: blur` 以防止“主进程内存洪泛”。
- **风险点**：工作流执行时的 **连线动画（CoolEdge）** 产生的渲染指令可能被大量堆积在浏览器的 GPU 渲染队列中，导致主进程（负责窗口组合与显示）内存暴增。即使渲染进程占用不高，主进程也会因为无法及时处理海量渲染指令而内存爆炸。

### 4.2 IPC (进程间通信) 压力（已经排除，不是主要原因）

- **现象**：工作流在流式生成正文时，每 500ms 触发一次 `onNovelUpdate`。
- **风险点**：如果 `Novel` 对象非常大（包含数百章正文、版本历史等），频繁的跨进程传递（通过前端 React 状态到主进程或开发工具）会导致 IPC 通道压力。主进程在处理这些海量序列化数据时，内存会迅速被垃圾回收（GC）无法跟上的中间对象填满。

### 4.3 `virtual:terminal` 日志溢出（不是主要原因）

- **现象**：代码中大量使用 `terminal.log` 打印流式输出统计。
- **风险点**：这些日志通过浏览器 IPC 转发。如果生成速度极快且持续时间长，主进程的控制台输出缓存可能成为内存黑洞。

### 4.4 `KeepAliveManager` 资源占用

- **现象**：[`KeepAliveManager`](src/utils/KeepAliveManager.ts) 持续播放循环音频并维持 `Wake Lock`。
- **风险点**：虽然音频只有1秒，但如果浏览器多媒体进程在工作流高负载下出现死锁，也可能拖累主进程性能。

## 5. 针对性修复建议 (已完成修复记录)

### 5.1 GPU 与渲染性能修复 (针对 4.1) - [已修复]

- **已移除样式节点爆炸**：将 `CoolEdge` 重复定义的 `@keyframes` 移至全局 CSS，防止了 CSSOM 树随连线数量爆炸增长。
- **已精简 SVG 层级**：合并了连线的发光层，并移除了性能开销极大的 `<animateMotion>` 动画标签。

### 5.2 IPC (进程间通信) 压力修复 (针对 4.2) - [已完成]

- **原理**：GB 级内存爆炸的根本原因在于流式输出期间，每秒多次传递包含全量正文、历史版本和设定集的超大 `Novel` 对象。这些对象在主进程缓冲区堆积，导致内存迅速耗尽。
- **修复方案**：
  - **增量更新 (Delta Update)**：修改 [`src/utils/auto-write/index.ts`](src/utils/auto-write/index.ts)，使其在流式生成和异步润色期间仅上报受影响的章节片段（Delta）。
  - **增量合并逻辑**：在 [`src/components/WorkflowEditor.tsx`](src/components/WorkflowEditor.tsx) 的执行循环中引入了 `Map` 驱动的增量合并逻辑，实现了“按需同步”，彻底终结了海量全量对象的跨进程传输。

### 5.3 `virtual:terminal` 日志溢出修复 (针对 4.3) - [已完成]

- **原理**：高频执行的 `terminal.log` 会跨进程占用浏览器主进程的控制台缓冲区，导致内存持续堆积。
- **修复方案**：
  - **移除高频进度日志**：剔除了 `AutoWriteEngine` 中每收到一个 Chunk 都要触发的 Token 级进度日志。
  - **日志分级与报警阈值化**：修改了 `App.tsx` 等处的性能监控逻辑，仅在 UI 渲染或状态合并耗时超过严重阈值（如 100ms）时才发送报警日志，普通性能数据改为静默或低频输出。

### 5.4 `KeepAliveManager` 资源占用修复 (针对 4.4) - [已完成]

- **原理**：持续循环播放 1 秒静音音频可能导致浏览器多媒体进程负载堆积，在高强度工作流环境下引发主进程内存异常增长。
- **修复方案**：
  - **彻底移除音频保活**：由于现代浏览器对 `Wake Lock` 的支持已足够稳定且能满足需求，移除了 [`src/utils/KeepAliveManager.ts`](src/utils/KeepAliveManager.ts) 中的音频播放逻辑，消除了多媒体相关的潜在内存风险。
