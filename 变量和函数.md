# AI 小说写作助手项目分析报告

## 1. 项目概览

本项目是一个基于 React + Vite + Tailwind CSS 构建的单页应用 (SPA)，旨在利用 AI (OpenAI API) 辅助小说创作。项目采用单体组件架构，核心逻辑高度集中在 `src/App.tsx` 中。

**核心功能流：**
多设定集管理 (世界观/角色/大纲) -> 智能生成/扩充设定 -> 全自动/辅助写作 -> 两阶段润色优化 -> 导出

## 2. 核心数据结构 (Interfaces)

项目通过 TypeScript 接口定义了严谨的数据模型，最新版本引入了“集合 (Set)”概念以支持多套设定。

### 2.1 小说与章节
*   **`Novel`**: 小说顶层对象。
    *   `id`, `title`, `systemPrompt`: 基本信息。
    *   `volumes`: `NovelVolume[]` 分卷列表。
    *   `chapters`: `Chapter[]` 章节列表。
    *   `outlineSets`: `OutlineSet[]` 大纲集合列表 (替代旧版 `outline`)。
    *   `characterSets`: `CharacterSet[]` 角色集合列表 (替代旧版 `characters`)。
    *   `worldviewSets`: `WorldviewSet[]` 世界观集合列表 (替代旧版 `worldview`)。
*   **`Chapter`**: 章节对象。
    *   `id`, `title`, `content`: 基本信息。
    *   `volumeId`: 所属分卷 ID。
    *   `versions`: `ChapterVersion[]` 版本历史 (原文、优化版、用户编辑版)。
    *   `activeVersionId`: 当前显示的版本 ID。
    *   `subtype`: 章节类型 ('story' 正文, 'small_summary' 小总结, 'big_summary' 大总结)。
    *   `summaryRange`: 总结覆盖的章节范围 (如 "1-5")。

### 2.2 设定集 (Sets)
*   **`OutlineSet` / `CharacterSet` / `WorldviewSet`**:
    *   `id`, `name`: 集合标识。
    *   `items` / `characters` / `entries`: 具体的数据项数组。
    *   `userNotes`: 用户输入的备注/上下文，AI 生成时会自动追加记录。

### 2.3 预设与配置
*   **`GeneratorPreset`**: 生成器预设 (用于大纲/角色/世界观/优化/分析)。
    *   `prompts`: `GeneratorPrompt[]` 提示词链。
    *   `apiConfig`: `PresetApiConfig` 独立的 API 配置 (Key, URL, Model)。
*   **`CompletionPreset`**: 写作补全预设。
    *   `contextLength`, `maxReplyLength`: Token 限制。
    *   `temperature`, `topP`, `frequencyPenalty` 等 LLM 参数。
    *   `regexScripts`: 绑定的正则处理脚本。

## 3. 关键变量与状态 (State Variables)

主要状态存储在 `App` 组件中，并利用 `localStorage` 实现数据持久化。

### 3.1 核心数据状态
*   **`novels`**: `Novel[]` - 所有小说的完整数据。
*   **`activeNovelId`**: `string` - 当前编辑的小说 ID。
*   **`activeChapterId`**: `number` - 当前选中的章节 ID。
*   **`activeOutlineSetId` / `activeCharacterSetId` / `activeWorldviewSetId`**: 当前选中的设定集 ID。

### 3.2 配置与环境
*   **全局 API 配置**: `apiKey`, `baseUrl`, `model` (默认模型)。
*   **专用模型配置**: `outlineModel`, `characterModel`, `worldviewModel`, `optimizeModel`, `analysisModel`。
*   **`longTextMode`**: `boolean` - **长文模式开关**。
*   **`contextScope`**: `'all' | 'current' | string` - 上下文发送范围 (全书/当前卷/指定卷)。
*   **`twoStepOptimization`**: `boolean` - **两阶段优化开关** (先分析后修改)。

### 3.3 自动化与生成状态
*   **`isAutoWriting`**: `boolean` - 是否处于“全自动写作”循环中。
*   **`autoWriteStatus`**: `string` - 自动写作进度提示。
*   **`optimizingChapterIds`**: `Set<number>` - 正在进行优化的章节 ID 集合。
*   **`globalCreationPrompt`**: `string` - 全局创作提示词 (注入到所有生成任务的 System Prompt)。

## 4. 核心功能函数 (Functions)

### 4.1 内容生成 (Generators)

*   **`handleGenerateOutline` / `Characters` / `Worldview`**
    *   **功能**: 基于预设和用户输入生成设定内容。
    *   **流程**:
        1. 获取当前选中的设定集 (Set)。
        2. 构建上下文：
            *   包含关联的设定 (如生成角色时参考世界观)。
            *   包含 `userNotes` (用户备注)。
            *   包含现有的列表内容 (用于增量生成)。
        3. 调用 API (支持独立 API Config)。
        4. 解析 JSON (使用 `safeParseJSONArray`) 并标准化 (`normalizeGeneratorResult`)。
        5. 将结果追加到当前 Set，并自动记录用户 Prompt 到 `userNotes`。

### 4.2 写作与优化 (Writing & Optimization)

*   **`handleGenerate`** (辅助写作)
    *   **功能**: 单章续写。
    *   **逻辑**: 
        1. 调用 `getChapterContext` 构建上下文 (包含前文、摘要、世界观)。
        2. 应用正则脚本 (`processTextWithRegex`) 处理输入。
        3. 流式生成内容并实时更新 UI。
        4. 生成完成后，触发正则后处理、自动总结检查 (`checkAndGenerateSummary`) 和自动润色。

*   **`autoWriteLoop`** (全自动写作)
    *   **功能**: 递归地自动撰写整卷/整本小说。
    *   **逻辑**: 
        *   遍历大纲条目。
        *   **断点续写**: 自动跳过内容已存在的章节。
        *   自动创建新章节。
        *   调用 LLM 生成正文，完成后自动递归调用自身处理下一章。

*   **`handleOptimize`** (润色优化)
    *   **功能**: 对章节内容进行 AI 润色。
    *   **逻辑**:
        *   **Phase 1 (Analysis)**: (如果开启两阶段优化) 先调用 `analysisModel` 分析文章优缺点，生成修改建议。
        *   **Phase 2 (Rewriting)**: 将原文 + (修改建议) 发送给 `optimizeModel` 进行重写。
        *   结果作为新的 `ChapterVersion` 存储，不覆盖原文。

### 4.3 长文模式支持 (Long Text Mode)

*   **`getChapterContext`**
    *   **功能**: 智能构建 Context Window。
    *   **逻辑**: 
        *   根据 `contextScope` 过滤章节 (如仅限当前卷)。
        *   查找最近的“大总结” (Big Summary)。
        *   查找大总结之后的“小总结” (Small Summaries)。
        *   查找最近的数章正文 (Story Chapters)。
        *   组合成 Token 利用率最高的上下文。

*   **`checkAndGenerateSummary`**
    *   **功能**: 自动维护摘要链。
    *   **逻辑**: 每当章节数达到阈值 (`smallSummaryInterval` / `bigSummaryInterval`)，自动触发后台生成任务，创建特殊的 Summary 章节。

*   **`handleScanSummaries`**
    *   **功能**: 扫描全书，补全所有缺失的摘要节点。

### 4.4 工具函数 (Helpers)

*   **`ensureChapterVersions`**: 确保章节对象拥有版本数组，用于旧数据迁移。
*   **`safeParseJSONArray`**: 鲁棒的 JSON 解析器，能从 AI 的混合文本回复中提取 JSON 数组。
*   **`processTextWithRegex`**: 执行用户定义的正则替换脚本。
*   **`handleExportNovel`**: 导出小说为 TXT，支持按卷组织结构。

## 5. 总结

代码库已从早期的单一数据结构演进为支持**多设定集 (Multi-Set)** 的复杂系统。核心逻辑增强了**上下文管理** (通过 `userNotes` 和长文模式) 以及**版本控制** (Chapter Versions)。“全自动写作”和“两阶段优化”是当前最复杂的两个业务流程，涉及大量的状态管理和异步操作。
