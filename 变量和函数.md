# AI 小说写作助手项目分析报告

## 1. 项目概览

本项目是一个基于 React + Vite + Tailwind CSS 构建的单页应用 (SPA)，旨在利用 AI (OpenAI API) 辅助小说创作。项目采用单体组件架构，核心逻辑高度集中在 `src/App.tsx` 中。

**核心功能流：**
世界观/角色设定 -> 智能生成大纲 -> 全自动/辅助写作 -> 润色优化 -> 导出

## 2. 核心数据结构 (Interfaces)

项目通过 TypeScript 接口定义了严谨的数据模型：

*   **`Novel`**: 小说顶层对象。
    *   包含了 `chapters` (章节)、`volumes` (分卷)。
    *   包含了设定集：`characterSets` (角色集)、`worldviewSets` (世界观集)、`outlineSets` (大纲集)。
*   **`Chapter`**: 章节对象。
    *   支持多版本管理 (`versions`)，用于保存原文、优化版或用户编辑版。
    *   支持特殊类型 (`subtype`)，如 'story' (正文)、'small_summary' (小总结)、'big_summary' (大总结)。
*   **`GeneratorPreset`**: 生成器预设。
    *   用于配置生成大纲、角色、世界观时的 Prompt 模板和模型参数。
*   **`CompletionPreset`**: 写作预设。
    *   用于配置正文生成时的 System Prompt、User Prompt 模板及 LLM 参数 (Temperature, TopP 等)。

## 3. 关键变量与状态 (State Variables)

主要状态存储在 `App` 组件中，并利用 `localStorage` 实现数据持久化。

### 3.1 数据存储
*   **`novels`**: `Novel[]`
    *   存储所有小说的核心状态数组。所有的增删改查最终都会更新这个状态。
*   **`activeNovelId`**: `string | null`
    *   当前正在编辑的小说 ID。
*   **`activeChapterId`**: `number | null`
    *   当前选中的章节 ID。

### 3.2 配置与环境
*   **API 配置**: `apiKey`, `baseUrl`, `model` (默认模型)。
*   **专用模型**: `outlineModel`, `characterModel`, `worldviewModel`, `optimizeModel` (允许为不同任务指定不同模型)。
*   **`longTextMode`**: `boolean`
    *   **长文模式开关**。开启后，系统会自动维护“小总结”和“大总结”，以解决 LLM 上下文窗口限制问题。
*   **`autoOptimize`**: `boolean`
    *   写作完成后是否自动触发润色功能。

### 3.3 自动化状态
*   **`isAutoWriting`**: `boolean`
    *   标记是否处于“全自动写作”循环中。
*   **`autoWriteStatus`**: `string`
    *   显示当前自动写作的进度（如：“正在创作第 3 章...”）。
*   **`globalCreationPrompt`**: `string`
    *   全局创作提示词，会作为 System Prompt 的一部分注入到所有生成请求中。

## 4. 核心功能函数 (Functions)

### 4.1 内容生成 (AI Generation)

*   **`handleGenerate`** (辅助写作)
    *   **功能**: 根据用户输入和上下文续写正文。
    *   **逻辑**: 
        1. 构建上下文（前文摘要 + 世界观 + 角色）。
        2. 应用正则脚本预处理输入。
        3. 调用 API 流式生成。
        4. 应用正则脚本后处理输出。
        5. 触发长文模式的总结检查 (`checkAndGenerateSummary`)。

*   **`autoWriteLoop`** (全自动写作)
    *   **功能**: 基于大纲列表，递归地自动撰写整本小说。
    *   **逻辑**: 这是一个递归函数。它会遍历大纲条目，为每一章生成内容，自动维护上下文，并在完成后自动进入下一章的生成，直到大纲结束或被中断。

*   **`handleOptimize`** (润色)
    *   **功能**: 优化当前章节内容。
    *   **逻辑**: 生成的内容不会直接覆盖原文，而是作为一个新的 `ChapterVersion` 存储，用户可以在不同版本间切换。

*   **`handleGenerateOutline` / `Characters` / `Worldview`**
    *   **功能**: 批量生成大纲、角色或世界观。
    *   **逻辑**: 解析 AI 返回的 JSON 数据（使用 `safeParseJSONArray`），并将其标准化合并到当前设定集中。

### 4.2 长文模式支持 (Long Text Mode)

*   **`checkAndGenerateSummary`**
    *   **功能**: 自动维护剧情摘要。
    *   **逻辑**: 
        *   当累积一定数量（如3章）的新章节时，自动调用 AI 生成“小总结”。
        *   当累积一定数量的“小总结”时，自动生成“大总结”。
        *   这些总结作为特殊的章节类型存储，用于在生成新内容时提供宏观上下文，从而突破 Token 限制。

*   **`getChapterContext`**
    *   **功能**: 智能构建发送给 AI 的上下文。
    *   **逻辑**: 根据当前位置和配置，提取最近的正文、最近的“小总结”和“大总结”，组合成最优的 Context Window。

### 4.3 工具与辅助

*   **`processTextWithRegex`**: 
    *   运行用户定义的正则脚本，用于清洗 AI 输出（如去除多余的 Markdown 符号）或预处理用户输入。
*   **`handleExportNovel`**: 
    *   将小说及其所有分卷、章节打包导出为格式化的 TXT 文件。

## 5. 总结

该项目是一个功能完备的 AI 辅助写作 IDE。它不仅仅是一个简单的 API 包装器，而是深入解决了长篇写作中的**上下文记忆**（通过长文模式摘要系统）和**结构化创作**（通过大纲/设定集驱动）两大痛点。代码结构虽然集中，但模块划分清晰，具备很高的实用价值。
